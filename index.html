<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ozark Pairings Builder</title>
  <style>
    :root{
      --bg:#0b0f0d; --panel:#111617; --muted:#1b2526; --accent:#8bd3dd; --accent-2:#b7e4c7;
      --text:#e7f2f3; --hint:#99a4a6; --danger:#ff6b6b; --ok:#63e6be; --gold:#f1c40f;
      --card:#0f1415; --ink:#0b0f0d; --line:#223033; --shadow:rgba(0,0,0,.35);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 10% -10%,#132022 0%,#0b0f0d 45%,#0b0f0d 100%);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    .app{display:grid;grid-template-columns:320px 1fr 420px;gap:16px;height:100%;padding:16px}
    header{grid-column:1/-1;background:linear-gradient(180deg,#0e1516,#0a0e0f);border:1px solid var(--line);border-radius:14px;padding:12px 16px;box-shadow:0 6px 20px var(--shadow);display:flex;align-items:center;gap:12px}
    h1{margin:0;font-size:20px;letter-spacing:.3px}
    .badge{padding:.2rem .5rem;border:1px solid var(--line);border-radius:999px;color:var(--accent-2);font-size:12px}

    .panel{background:linear-gradient(180deg,#101617,#0e1314);border:1px solid var(--line);border-radius:14px;box-shadow:0 10px 30px var(--shadow);overflow:hidden;display:flex;flex-direction:column;min-height:0}
    .panel .head{display:flex;align-items:center;gap:10px;padding:10px 12px;border-bottom:1px solid var(--line);background:#0c1111}
    .panel .head h2{font-size:14px;letter-spacing:.4px;margin:0;color:#cfe6e8;text-transform:uppercase}
    .panel .body{padding:12px;overflow:auto}

    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row + .row{margin-top:8px}
    label{font-size:12px;color:var(--hint)}
    input[type="text"], input[type="number"], select{background:#0e1415;border:1px solid var(--line);color:var(--text);padding:8px 10px;border-radius:10px;outline:none}
    input:focus, select:focus{border-color:#2d4b4f;box-shadow:0 0 0 3px #2d4b4f44}
    .btn{background:#132325;border:1px solid #234246;color:var(--text);padding:8px 12px;border-radius:12px;cursor:pointer}
    .btn:hover{filter:brightness(1.1)}
    .btn.primary{background:#17393d;border-color:#2a6f77;color:#c9fbff}
    .btn.warn{background:#3d1717;border-color:#772a2a;color:#ffd6d6}

    .pool{display:flex;flex-direction:column;gap:10px}
    .pool-controls{display:flex;gap:8px;flex-wrap:wrap}
    .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#101717;color:#bfe7ea;font-size:12px;cursor:pointer;user-select:none}
    .pill.active{background:#17393d;border-color:#2a6f77;color:#dcffff}
    .players{display:grid;grid-template-columns:1fr;gap:6px;min-height:80px}
    .player{display:flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--line);padding:8px;border-radius:12px;cursor:grab}
    .player:active{cursor:grabbing}
    .dot{width:10px;height:10px;border-radius:50%}
    .dot.ozark{background:#2ecc71}
    .dot.valley{background:#3498db}
    .meta{font-size:12px;color:#a7b1b2}

    .builder-controls{display:grid;grid-template-columns:repeat(4,1fr);gap:8px;margin-bottom:8px}
    .tabs{display:flex;gap:6px}
    .tabs.segment{background:#0e1415;padding:4px;border:1px solid var(--line);border-radius:999px}
    .tab{padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1617;color:#bfe7ea;font-size:12px;cursor:pointer}
    .tab.active{background:#17393d;border-color:#2a6f77;color:#dcffff}

    .grid{display:grid;grid-template-columns:repeat(2, minmax(280px, 1fr));gap:10px}
    .card{background:#0e1415;border:1px solid var(--line);border-radius:14px;padding:10px;display:flex;flex-direction:column;gap:10px;min-height:110px}
    .card h3{margin:0;font-size:14px;letter-spacing:.3px;display:flex;justify-content:space-between;align-items:center}
    .subheads{display:grid;grid-template-columns:1fr 1fr;gap:6px;font-size:11px;color:#a7b1b2}
    .subheads span{padding:4px 8px;border:1px solid #223033;border-radius:8px;background:#0e1415;text-align:center}
    .slots{display:grid;gap:6px}
    .slots.team{grid-template-columns:1fr 1fr}
    .slots.team .col{display:grid;grid-template-columns:1fr;gap:6px}
    .slots.singles{grid-template-columns:repeat(2,1fr)}
    .slot{background:#0b1011;border:1px dashed #2a3a3d;border-radius:10px;min-height:36px;display:flex;align-items:center;justify-content:center;padding:6px;color:#789195}
    .slot.filled{border-style:solid;border-color:#335a60;background:#0f191a;color:#d9f8fb}
    .slot.dragover{outline:2px dashed var(--accent);outline-offset:2px}

    .legend{display:flex;gap:10px;align-items:center;font-size:12px;color:#a7b1b2}
    .legend .swatch{width:10px;height:10px;border-radius:50%}

    .side .body{display:flex;flex-direction:column;gap:10px}
    .list{background:#0d1314;border:1px solid var(--line);border-radius:12px;overflow:auto}
    .list table{width:100%;border-collapse:collapse;font-size:12px}
    .list th,.list td{padding:8px;border-bottom:1px solid #1b2a2c}
    .list th{text-align:left;color:#b6cacc;position:sticky;top:0;background:#0f1516}

    @media print{
      body{background:#fff;color:#000}
      header,.panel:not(.printable){display:none}
      .printable{display:block;border:none;box-shadow:none}
    }

    /* Leaderboard polish */
    body, table { font-variant-numeric: tabular-nums; }
    header { border-radius: 16px; border-top: 2px solid #2b3b3e; box-shadow: 0 12px 40px var(--shadow), inset 0 1px 0 #1a2324; }
    header h1 { letter-spacing: .08em; text-transform: uppercase; font-weight: 700; }
    header .badge { background: linear-gradient(180deg,#0f1718,#0a0e10); border-color:#2a3b3e; color:#cfe6e8; box-shadow: inset 0 0 0 1px #0a0e10, 0 6px 18px rgba(0,0,0,.35); }
    .list tbody tr:nth-child(odd){ background: linear-gradient(180deg, #0b1112, #0a0f10); }
    .list tbody tr:hover{ background:#101a1b; }
    .list td:nth-child(3), .list td:nth-child(4), .list td:nth-child(5), .list td:nth-child(6){ text-align:center; font-weight:700; }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <h1>Ozark Pairings Builder</h1>
      <span class="badge">Captain pairing cards & printable sheets</span>
      <div style="margin-left:auto" class="row">
        <button id="btnPrint" class="btn primary">Print / PDF</button>
        <button id="btnExport" class="btn">Export JSON</button>
        <button id="btnImportCSV" class="btn">Import CSV (players)</button>
        <button id="btnImportPlayers" class="btn">Import Players (merge)</button>
        <button id="btnImportState" class="btn">Import State (replace)</button>
      </div>
    </header>

    <!-- Player Pool -->
    <section class="panel">
      <div class="head"><h2>Player Pool</h2></div>
      <div class="body pool">
        <div class="pool-controls">
          <input id="search" type="text" placeholder="Search name or nickname" style="flex:1" />
          <div id="teamFilters" class="row"></div>
        </div>
        <div class="legend">
          <div class="swatch" style="background:#2ecc71"></div> Team Ozark
          <div class="swatch" style="background:#3498db"></div> Team Valley
        </div>
        <div id="players" class="players" aria-live="polite"></div>
        <div class="row">
          <button id="btnReloadPool" class="btn">Reload from previous site</button>
          <button id="btnAddManual" class="btn">Add player</button>
        </div>
      </div>
    </section>

    <!-- Builder -->
    <section class="panel">
      <div class="head"><h2>Builder</h2></div>
      <div class="body">
        <div class="builder-controls">
          <div class="row">
            <label>Event</label>
            <input id="eventName" type="text" placeholder="Ozark Invitational 2026" />
          </div>

          <div class="row">
            <label>Date (Day 1)</label>
            <input id="eventDate1" type="text" placeholder="2026-06-20" />
          </div>
          <div class="row">
            <label>Date (Day 2)</label>
            <input id="eventDate2" type="text" placeholder="2026-06-21" />
          </div>

          <div class="row">
            <label>Groups (both days)</label>
            <input id="numGroups" type="number" min="1" max="12" value="6" />
          </div>
        </div>

        <div class="row" style="justify-content:space-between;margin:8px 0 12px">
          <div class="row" style="gap:10px;align-items:center">
            <div class="tabs segment" id="dayTabs">
              <button class="tab active" data-day="day1">Day 1</button>
              <button class="tab" data-day="day2">Day 2</button>
            </div>
            <div class="tabs segment" id="tabs">
              <button class="tab active" data-side="front">Front 9</button>
              <button class="tab" data-side="back">Back 9</button>
            </div>
          </div>
          <div class="row">
            <label>Format</label>
            <select id="formatSelect">
              <option value="Best Ball">Best Ball (4-Ball)</option>
              <option value="Scramble">Scramble</option>
              <option value="Alt Shot">Alternate Shot</option>
              <option value="Shamble">Shamble</option>
              <option value="Singles">Singles Match Play</option>
            </select>
            <button id="btnClearSide" class="btn warn">Clear side</button>
          </div>
        </div>

        <div id="grid" class="grid" aria-live="polite"></div>
      </div>
    </section>

    <!-- Sidebar: Summary -->
    <aside class="panel side">
      <div class="head"><h2>Leaderboard &amp; Schedule</h2></div>
      <div class="body">
        <div class="row">
          <div class="pill" id="pillOnce">Validate: each player used once per side</div>
          <div class="pill" id="pillBalance">Validate: team composition</div>
        </div>
        <div id="alerts"></div>

        <div class="list" aria-label="Assignments table">
          <table>
            <thead>
              <tr>
                <th style="width:36%">Player</th>
                <th>Team</th>
                <th>Front D1</th>
                <th>Back D1</th>
                <th>Front D2</th>
                <th>Back D2</th>
              </tr>
            </thead>
            <tbody id="assignmentTable"></tbody>
          </table>
        </div>
      </div>
    </aside>

    <!-- Print Layout -->
    <section id="printArea" class="panel printable" style="display:none;padding:16px">
      <div id="printContent"></div>
    </section>
  </div>

  <script>
    /*********************************
     *  0) DATA & STORAGE LAYER
     *********************************/
    const SIGNUPS_KEY = "ozarkSignups_v1";
    const STORAGE_KEY = "ozarkPairings_v3_twoDays";
    const TEAM_LABELS = { ozark: "Team Ozark", valley: "Team Valley" };
    const TEAM_COLORS = { ozark: "#2ecc71", valley: "#3498db" };
    const TEAM_FORMATS = new Set(['Best Ball','Scramble','Alt Shot','Shamble']);

    // State now includes two days
    let state = {
      players: [],
      filters: { team: "all", q: "" },
      currentDay: "day1", // 'day1' | 'day2'
      side: "front",      // 'front' | 'back'
      eventName: "Ozark Invitational 2026",
      dates: { day1: "2026-06-20", day2: "2026-06-21" },
      format: {
        day1: { front: "Best Ball", back: "Scramble" },
        day2: { front: "Alt Shot",  back: "Singles"  }
      },
      groups: {
        day1: { front: [], back: [] }, // array of groups -> array of player ids
        day2: { front: [], back: [] }
      },
      numGroups: 6
    };

    function uid(){ return Math.random().toString(36).slice(2,9) }
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)) }
    function load(){ try{ const r = localStorage.getItem(STORAGE_KEY); if(r){ state = JSON.parse(r); } }catch{} }

    function loadPlayersFromPreviousSite(){
      try{
        const raw = localStorage.getItem(SIGNUPS_KEY);
        if(!raw) return [];
        const arr = JSON.parse(raw);
        return (arr||[]).map((p)=>({
          id: p.id || uid(),
          firstName: p.firstName || (p.name?.split(" ")[0]||""),
          lastName: p.lastName || (p.name?.split(" ").slice(1).join(" ")||""),
          nickname: p.nickname || "",
          team: (p.team||"").toLowerCase().includes("valley")?"valley":"ozark",
          email: p.email||"",
          phone: p.phone||""
        }));
      }catch{ return [] }
    }

    function ensurePlayers(){
      if(state.players && state.players.length) return;
      const prior = loadPlayersFromPreviousSite();
      if(prior.length){ state.players = prior; return; }
      state.players = [
        {id:uid(), firstName:"Nick", lastName:"Brown", nickname:"Frenzy", team:"ozark"},
        {id:uid(), firstName:"Chris", lastName:"B.", nickname:"CB", team:"ozark"},
        {id:uid(), firstName:"Alex", lastName:"M.", nickname:"", team:"valley"},
        {id:uid(), firstName:"Jordan", lastName:"S.", nickname:"J-Smooth", team:"valley"}
      ];
    }

    /*********************************
     *  1) RENDER: PLAYER POOL
     *********************************/
    const elPlayers = document.getElementById('players');
    const elTeamFilters = document.getElementById('teamFilters');
    const elSearch = document.getElementById('search');

    function renderTeamFilters(){
      elTeamFilters.innerHTML = '';
      const teams = ['all','ozark','valley'];
      teams.forEach(t=>{
        const b = document.createElement('div');
        b.className = 'pill' + (state.filters.team===t?' active':'');
        b.textContent = t==='all'? 'All' : TEAM_LABELS[t];
        b.addEventListener('click',()=>{ state.filters.team = t; renderPlayers(); renderAssignmentsTable(); save(); });
        elTeamFilters.appendChild(b);
      });
    }

    function playerDisplayName(p){
      const nick = p.nickname && p.nickname.trim()?.length ? `"${p.nickname}" `:'';
      return `${p.firstName} ${nick}${p.lastName}`.replace(/\s+/g,' ').trim();
    }

    function renderPlayers(){
      const q = (state.filters.q||'').toLowerCase();
      const team = state.filters.team;
      elPlayers.innerHTML = '';
      const used = new Set((state.groups[state.currentDay][state.side]||[]).flat());
      state.players
        .filter(p => team==='all' || p.team===team)
        .filter(p => playerDisplayName(p).toLowerCase().includes(q))
        .sort((a,b)=> a.team.localeCompare(b.team) || playerDisplayName(a).localeCompare(playerDisplayName(b)))
        .forEach(p=>{
          const card = document.createElement('div');
          card.className = 'player';
          card.draggable = true;
          card.dataset.id = p.id;
          card.innerHTML = `
            <div class="dot ${p.team}" style="background:${TEAM_COLORS[p.team]}"></div>
            <div>
              <div>${playerDisplayName(p)}</div>
              <div class="meta">${TEAM_LABELS[p.team]}</div>
            </div>`;
          if(used.has(p.id)) card.style.opacity = .45;
          card.addEventListener('dragstart', onDragPlayer);
          elPlayers.appendChild(card);
        });
    }

    elSearch.addEventListener('input', (e)=>{ state.filters.q = e.target.value; renderPlayers(); });

    document.getElementById('btnReloadPool').addEventListener('click', ()=>{
      const fromOld = loadPlayersFromPreviousSite();
      if(fromOld.length){ state.players = mergePlayers(state.players, fromOld); save(); renderAll(); alert('Loaded players from previous site signups.'); }
      else alert('No signups found under key '+SIGNUPS_KEY+'. Add players manually or use an Import button.');
    });

    document.getElementById('btnAddManual').addEventListener('click', ()=>{
      const firstName = prompt('First name?'); if(!firstName) return;
      const lastName = prompt('Last name?')||'';
      const nickname = prompt('Nickname (optional)')||'';
      const team = (prompt('Team: ozark / valley','ozark')||'ozark').toLowerCase().includes('val')?'valley':'ozark';
      state.players.push({id:uid(), firstName, lastName, nickname, team}); save(); renderAll();
    });

    function mergePlayers(existing, incoming){
      const byKey = x=> (x.firstName+'|'+x.lastName+'|'+(x.email||'')).toLowerCase();
      const map = new Map(existing.map(p=>[byKey(p), p]));
      incoming.forEach(p=>{
        const np = normalizePlayer(p);
        const k = byKey(np);
        if(!map.has(k)) map.set(k,np);
      });
      return Array.from(map.values());
    }

    /*********************************
     *  2) BUILDER GRID (Per Day + Side)
     *********************************/
    const elGrid   = document.getElementById('grid');
    const elTabs   = document.getElementById('tabs');
    const elDayTabs= document.getElementById('dayTabs');
    const elFormat = document.getElementById('formatSelect');

    function desiredGroupSize(fmt){ return TEAM_FORMATS.has(fmt) ? 4 : 2; }

    function initGroupsIfNeeded(){
      ['day1','day2'].forEach(day=>{
        ['front','back'].forEach(side=>{
          if(!Array.isArray(state.groups[day][side])) state.groups[day][side] = [];
          // ensure numGroups
          if(state.groups[day][side].length !== state.numGroups){
            state.groups[day][side] = Array.from({length: state.numGroups}, (_,i)=> (state.groups[day][side][i]||[]));
          }
          // ensure group arrays sized for current format
          const fmt = state.format[day][side];
          const gs = desiredGroupSize(fmt);
          state.groups[day][side] = state.groups[day][side].map(g=>{
            const arr = g.slice(0, gs);
            while (arr.length < gs) arr.push(null);
            return arr;
          });
        });
      });
    }

    function renderGrid(){
      initGroupsIfNeeded();
      elGrid.innerHTML = '';
      const day = state.currentDay;
      const side = state.side;
      const fmt = state.format[day][side];
      const isTeam = TEAM_FORMATS.has(fmt);

      state.groups[day][side].forEach((group, idx)=>{
        const card = document.createElement('div');
        card.className = 'card';
        const dayLabel = day==='day1' ? 'Day 1' : 'Day 2';
        card.innerHTML = `<h3>${dayLabel} • ${side==='front'?'Front 9':'Back 9'} • ${fmt}</h3>`;

        if(isTeam){
          const sub = document.createElement('div');
          sub.className = 'subheads';
          sub.innerHTML = `<span>Team A</span><span>Team B</span>`;
          card.appendChild(sub);
        }

        const slotsWrap = document.createElement('div');
        slotsWrap.className = 'slots ' + (isTeam ? 'team' : 'singles');

        if(isTeam){
          const colA = document.createElement('div'); colA.className = 'col';
          const colB = document.createElement('div'); colB.className = 'col';
          colA.appendChild(buildSlot(day, side, idx, 0, group[0]));
          colA.appendChild(buildSlot(day, side, idx, 1, group[1]));
          colB.appendChild(buildSlot(day, side, idx, 2, group[2]));
          colB.appendChild(buildSlot(day, side, idx, 3, group[3]));
          slotsWrap.appendChild(colA);
          slotsWrap.appendChild(colB);
        }else{
          slotsWrap.appendChild(buildSlot(day, side, idx, 0, group[0]));
          slotsWrap.appendChild(buildSlot(day, side, idx, 1, group[1]));
        }

        card.appendChild(slotsWrap);
        elGrid.appendChild(card);
      });
      // reflect format control for current day/side
      elFormat.value = fmt;
    }

    function buildSlot(day, side, groupIndex, pos, playerId){
      const s = document.createElement('div');
      s.className = 'slot'+(playerId? ' filled':'');
      s.dataset.day = day;
      s.dataset.side = side;
      s.dataset.group = groupIndex;
      s.dataset.pos = pos;
      s.textContent = playerId ? playerDisplayName(findPlayer(playerId)) : 'Drop player here';
      s.addEventListener('dragover', e=>{ e.preventDefault(); s.classList.add('dragover'); });
      s.addEventListener('dragleave', ()=> s.classList.remove('dragover'));
      s.addEventListener('drop', e=> onDropToSlot(e, s));
      s.addEventListener('click', ()=> {
        if(state.groups[day][side][groupIndex][pos]){
          state.groups[day][side][groupIndex][pos] = null;
          save(); renderAll();
        }
      });
      return s;
    }

    function onDragPlayer(e){
      e.dataTransfer.setData('text/player', e.currentTarget.dataset.id);
    }

    function onDropToSlot(e, slot){
      e.preventDefault(); slot.classList.remove('dragover');
      const playerId = e.dataTransfer.getData('text/player');
      if(!playerId) return;
      assignPlayerToSlot(slot.dataset.day, slot.dataset.side, Number(slot.dataset.group), Number(slot.dataset.pos), playerId);
    }

    function assignPlayerToSlot(day, side, groupIndex, pos, playerId){
      initGroupsIfNeeded();
      // remove any existing placement for this player on this day+side
      for(const g of state.groups[day][side]){ for(let i=0;i<g.length;i++){ if(g[i]===playerId){ g[i]=null; } } }
      state.groups[day][side][groupIndex][pos] = playerId;
      save(); renderAll();
    }

    function findPlayer(id){ return state.players.find(p=>p.id===id) }

    // Controls
    document.getElementById('eventName').addEventListener('input', e=>{ state.eventName = e.target.value; save(); });
    document.getElementById('eventDate1').addEventListener('input', e=>{ state.dates.day1 = e.target.value; save(); });
    document.getElementById('eventDate2').addEventListener('input', e=>{ state.dates.day2 = e.target.value; save(); });
    document.getElementById('numGroups').addEventListener('input', e=>{
      state.numGroups = Math.max(1, Math.min(12, Number(e.target.value)||1));
      initGroupsIfNeeded(); renderAll(); save();
    });

    elDayTabs.addEventListener('click', (e)=>{
      const t = e.target.closest('.tab'); if(!t) return;
      document.querySelectorAll('#dayTabs .tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      state.currentDay = t.dataset.day;
      save(); renderAll();
    });

    elTabs.addEventListener('click', (e)=>{
      const t = e.target.closest('.tab'); if(!t) return;
      document.querySelectorAll('#tabs .tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      state.side = t.dataset.side; save(); renderAll();
    });

    elFormat.addEventListener('change', (e)=>{
      state.format[state.currentDay][state.side] = e.target.value;
      // adjust group lengths for this side/day to match format size
      const gs = desiredGroupSize(e.target.value);
      state.groups[state.currentDay][state.side] =
        state.groups[state.currentDay][state.side].map(g=>{
          const a = g.slice(0, gs);
          while (a.length < gs) a.push(null);
          return a;
        });
      save(); renderAll();
    });

    document.getElementById('btnClearSide').addEventListener('click', ()=>{
      const day = state.currentDay, side = state.side;
      if(confirm(`Clear all groups on ${day==='day1'?'Day 1':'Day 2'} ${side==='front'?'Front 9':'Back 9'}?`)){
        const gs = desiredGroupSize(state.format[day][side]);
        state.groups[day][side] = Array.from({length: state.numGroups}, ()=> Array(gs).fill(null));
        save(); renderAll();
      }
    });

    /*********************************
     *  3) SUMMARY & VALIDATION
     *********************************/
    const elAlerts = document.getElementById('alerts');
    const elAssignTable = document.getElementById('assignmentTable');

    function renderAssignmentsTable(){
      const used = {
        day1: { front:new Map(), back:new Map() },
        day2: { front:new Map(), back:new Map() },
      };
      (state.groups.day1.front||[]).forEach((g,i)=> g.forEach(pid=>{ if(pid) used.day1.front.set(pid, i+1) }))
      (state.groups.day1.back ||[]).forEach((g,i)=> g.forEach(pid=>{ if(pid) used.day1.back.set(pid, i+1) }))
      (state.groups.day2.front||[]).forEach((g,i)=> g.forEach(pid=>{ if(pid) used.day2.front.set(pid, i+1) }))
      (state.groups.day2.back ||[]).forEach((g,i)=> g.forEach(pid=>{ if(pid) used.day2.back.set(pid, i+1) }))

      const rows = state.players.map(p=>{
        const tr = document.createElement('tr');
        tr.innerHTML =
          `<td>${playerDisplayName(p)}</td><td>${TEAM_LABELS[p.team]}</td>`+
          `<td>${used.day1.front.get(p.id)||''}</td>`+
          `<td>${used.day1.back.get(p.id)||''}</td>`+
          `<td>${used.day2.front.get(p.id)||''}</td>`+
          `<td>${used.day2.back.get(p.id)||''}</td>`;
        return tr;
      });
      elAssignTable.innerHTML = ''; rows.forEach(r=> elAssignTable.appendChild(r));

      const problems = [];

      // once per side per day
      ['day1','day2'].forEach(day=>{
        const label = day==='day1'?'Day 1':'Day 2';
        state.players.forEach(p=>{
          if(!used[day].front.has(p.id)) problems.push(`${label} Front: ${playerDisplayName(p)} not placed`);
          if(!used[day].back.has(p.id))  problems.push(`${label} Back: ${playerDisplayName(p)} not placed`);
        });
      });

      // composition checks
      ['day1','day2'].forEach(day=>{
        ['front','back'].forEach(side=>{
          const fmt = state.format[day][side];
          const isTeam = TEAM_FORMATS.has(fmt);
          (state.groups[day][side]||[]).forEach((g,i)=>{
            const players = g.filter(Boolean).map(findPlayer);
            if(isTeam){
              if(players.length>0){
                const oz = players.filter(p=>p.team==='ozark').length;
                const va = players.filter(p=>p.team==='valley').length;
                if(players.length !== 4) problems.push(`${printSide(day,side)} Group ${i+1}: incomplete (needs 4 players: 2v2)`);
                else if(!(oz===2 && va===2)) problems.push(`${printSide(day,side)} Group ${i+1}: must be 2 OZ + 2 VA (now ${oz}/${va})`);
              }
            }else{
              if(players.length>0 && players.length!==2) problems.push(`${printSide(day,side)} Group ${i+1}: singles must be 1v1 (2 players)`);
            }
          });
        });
      });

      elAlerts.innerHTML = problems.length
        ? `<div class="card" style="border-color:#4d2626;background:#171112"><strong style="color:#ffb3b3">Needs attention</strong><ul style="margin:.3rem 0 .2rem .9rem">${problems.map(p=>`<li>${p}</li>`).join('')}</ul></div>`
        : `<div class="card" style="border-color:#244a3c;background:#0f1513"><strong style="color:#b9fbd2">Looks good</strong><div>Everyone is placed with correct pair sizes on both days.</div></div>`;
    }

    function printSide(day,side){
      return `${day==='day1'?'Day 1':'Day 2'} ${side==='front'?'Front 9':'Back 9'}`;
    }

    document.getElementById('pillOnce').addEventListener('click', ()=> alert('One placement per player per side per day is enforced when you drop a player again.'));
    document.getElementById('pillBalance').addEventListener('click', ()=> alert('Team events require 2v2 (2 Ozark + 2 Valley). Singles requires 1v1.'));

    /*********************************
     *  4) PRINT / EXPORT
     *********************************/
    const elPrintArea = document.getElementById('printArea');
    const elPrintContent = document.getElementById('printContent');

    document.getElementById('btnPrint').addEventListener('click', ()=>{
      buildPrint();
      window.print();
    });

    function buildPrint(){
      const css = `
        <style>
          .sheet{page-break-inside:avoid;border:1px solid #888;margin:12px 0;padding:12px;border-radius:10px}
          .sheet h2{margin:0 0 8px 0;font-size:18px}
          .sheet table{width:100%;border-collapse:collapse}
          .sheet th,.sheet td{border:1px solid #999;padding:6px;text-align:left;font-size:12px;vertical-align:top}
          .twocol{display:grid;grid-template-columns:1fr 1fr;gap:10px}
          .teams{display:grid;grid-template-columns:1fr 1fr;gap:8px}
          .teams .box{border:1px solid #bbb;padding:6px;border-radius:6px}
          .muted{color:#555}
        </style>`;

      const dayBlock = (day)=>{
        const date = state.dates[day] || '';
        const title = (day==='day1'?'Day 1':'Day 2') + (date ? ` • ${date}` : '');
        const sideBlock = (side)=>{
          const fmt = state.format[day][side];
          const isTeam = TEAM_FORMATS.has(fmt);
          const rows = (state.groups[day][side]||[]).map((g,i)=>{
            if(isTeam){
              const a = g.slice(0,2).filter(Boolean).map(findPlayer).map(p=> `${playerDisplayName(p)} <span class="muted">(${p.team==='ozark'?'OZ':'VA'})</span>`).join('<br/>') || '&nbsp;';
              const b = g.slice(2,4).filter(Boolean).map(findPlayer).map(p=> `${playerDisplayName(p)} <span class="muted">(${p.team==='ozark'?'OZ':'VA'})</span>`).join('<br/>') || '&nbsp;';
              return `<tr><td>${i+1}</td><td>${fmt}</td><td><div class="teams"><div class="box"><strong>Team A</strong><br/>${a}</div><div class="box"><strong>Team B</strong><br/>${b}</div></div></td></tr>`;
            }else{
              const names = g.slice(0,2).filter(Boolean).map(findPlayer).map(p=> `${playerDisplayName(p)} <span class="muted">(${p.team==='ozark'?'OZ':'VA'})</span>`).join('<br/>') || '&nbsp;';
              return `<tr><td>${i+1}</td><td>${fmt}</td><td>${names}</td></tr>`;
            }
          }).join('');
          return `<div class="sheet"><h2>${side==='front'?'Front 9':'Back 9'} • ${fmt}</h2><table><thead><tr><th>#</th><th>Format</th><th>Players</th></tr></thead><tbody>${rows}</tbody></table></div>`;
        };
        return `<div class="sheet"><h2>${title}</h2></div>${sideBlock('front')}${sideBlock('back')}`;
      };

      elPrintContent.innerHTML = css +
        `<h1 style="margin:0 0 6px">${state.eventName}</h1>` +
        `<div class="twocol">${dayBlock('day1')}${dayBlock('day2')}</div>`;
      elPrintArea.style.display = 'block';
    }

    document.getElementById('btnExport').addEventListener('click', ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:'application/json'});
      const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'ozark_pairings_twodays.json'; a.click();
    });

    /*********************************
     *  4.5) IMPORTS (PLAYERS MERGE / STATE REPLACE) + CSV SUPPORT
     *********************************/
    function normalizePlayer(n) {
      const id = n.id || uid();
      const first = n.firstName || (n.name ? n.name.split(' ')[0] : '');
      const last  = n.lastName  || (n.name ? n.name.split(' ').slice(1).join(' ') : '');
      const team  = (n.team || '').toLowerCase().includes('val') ? 'valley' : 'ozark';
      return { id, firstName:first||'', lastName:last||'', nickname: n.nickname || '', team, email: n.email || '', phone: n.phone || '' };
    }

    function mergeIntoPlayers(incomingArray) {
      const existing = state.players || [];
      const byKey = x => (x.firstName+'|'+x.lastName+'|'+(x.email||'')).toLowerCase();
      const map = new Map(existing.map(p => [byKey(p), p]));
      for (const raw of incomingArray) {
        const p = normalizePlayer(raw);
        const k = byKey(p);
        if (!map.has(k)) map.set(k, p);
      }
      state.players = Array.from(map.values());
      save(); renderAll();
    }

    document.getElementById('btnImportPlayers').addEventListener('click', () => {
      const inp = document.createElement('input');
      inp.type = 'file'; inp.accept = '.json,application/json';
      inp.onchange = () => {
        const f = inp.files?.[0]; if (!f) return;
        const r = new FileReader();
        r.onload = () => {
          try {
            const json = JSON.parse(r.result);
            const arr = Array.isArray(json) ? json : (json && Array.isArray(json.players) ? json.players : null);
            if (!arr) { alert('JSON should be an array of players or { "players": [...] }'); return; }
            mergeIntoPlayers(arr);
            alert('Players merged successfully.');
          } catch { alert('Could not parse JSON.'); }
        };
        r.readAsText(f);
      };
      inp.click();
    });

    document.getElementById('btnImportState').addEventListener('click', () => {
      if (!confirm('This will REPLACE your current event, players, and groups. Continue?')) return;
      const inp = document.createElement('input');
      inp.type = 'file'; inp.accept = '.json,application/json';
      inp.onchange = () => {
        const f = inp.files?.[0]; if (!f) return;
        const r = new FileReader();
        r.onload = () => {
          try {
            const obj = JSON.parse(r.result);
            if (!obj || !Array.isArray(obj.players)) { alert('State JSON must include a "players" array.'); return; }
            obj.players = obj.players.map(normalizePlayer);
            state = Object.assign({
              players: [],
              filters: { team: 'all', q: '' },
              currentDay: 'day1',
              side: 'front',
              eventName: state.eventName,
              dates: { day1: state.dates.day1, day2: state.dates.day2 },
              format: { day1:{front:'Best Ball',back:'Scramble'}, day2:{front:'Alt Shot',back:'Singles'} },
              groups: { day1:{front:[],back:[]}, day2:{front:[],back:[]} },
              numGroups: 6
            }, obj);
            initGroupsIfNeeded();
            save(); renderAll();
            alert('State imported and replaced.');
          } catch { alert('Could not parse state JSON.'); }
        };
        r.readAsText(f);
      };
      inp.click();
    });

    function parseCSV(text) {
      if (text && text.charCodeAt(0) === 0xFEFF) text = text.slice(1);
      const rows = [];
      let i = 0, cur = '', row = [], inQuotes = false;
      while (i < text.length) {
        const c = text[i];
        if (inQuotes) {
          if (c === '"') {
            if (text[i+1] === '"') { cur += '"'; i += 2; continue; }
            inQuotes = false; i++; continue;
          } else { cur += c; i++; continue; }
        }
        if (c === '"') { inQuotes = true; i++; continue; }
        if (c === ',') { row.push(cur); cur = ''; i++; continue; }
        if (c === '\n') { row.push(cur); rows.push(row); row = []; cur = ''; i++; continue; }
        if (c === '\r') { if (text[i+1] === '\n') i++; row.push(cur); rows.push(row); row = []; cur = ''; i++; continue; }
        cur += c; i++;
      }
      row.push(cur); rows.push(row);
      while (rows.length && rows[rows.length-1].every(v => (v||'').trim() === '')) rows.pop();
      return rows;
    }

    function playersFromCSV(csvText) {
      const rows = parseCSV(csvText);
      if (!rows.length) return [];
      const header = rows[0].map(h => h.trim().toLowerCase());
      const idx = name => header.indexOf(name);
      const iFirst = idx('firstname');
      const iLast  = idx('lastname');
      const iName  = idx('name');
      const iNick  = idx('nickname');
      const iTeam  = idx('team');
      const iEmail = idx('email');
      const iPhone = idx('phone');

      const out = [];
      for (let r = 1; r < rows.length; r++) {
        const row = rows[r];
        if (!row || row.every(v => (v||'').trim() === '')) continue;

        const rawName   = iName >= 0 ? (row[iName]||'').trim() : '';
        const firstName = iFirst >= 0 ? (row[iFirst]||'').trim() : (rawName ? rawName.split(' ')[0] : '');
        const lastName  = iLast  >= 0 ? (row[iLast]||'').trim()  : (rawName ? rawName.split(' ').slice(1).join(' ') : '');
        const nickname  = iNick  >= 0 ? (row[iNick]||'').trim() : '';
        const email     = iEmail >= 0 ? (row[iEmail]||'').trim() : '';
        const phone     = iPhone >= 0 ? (row[iPhone]||'').trim() : '';
        const teamRaw   = iTeam  >= 0 ? (row[iTeam]||'').trim().toLowerCase() : 'ozark';
        const team      = teamRaw.includes('val') ? 'valley' : 'ozark';

        out.push({ id: uid(), firstName, lastName, nickname, team, email, phone });
      }
      return out;
    }

    document.getElementById('btnImportCSV').addEventListener('click', () => {
      const inp = document.createElement('input');
      inp.type = 'file';
      inp.accept = '.csv,text/csv';
      inp.onchange = () => {
        const f = inp.files?.[0]; if (!f) return;
        const r = new FileReader();
        r.onload = () => {
          try {
            const players = playersFromCSV(String(r.result || ''));
            if (!players.length) { alert('No players found in CSV.'); return; }
            mergeIntoPlayers(players);
            alert(`Imported ${players.length} players from CSV.`);
          } catch { alert('Could not parse CSV.'); }
        };
        r.readAsText(f);
      };
      inp.click();
    });

    /*********************************
     *  5) INIT
     *********************************/
    function hydrateControls(){
      document.getElementById('eventName').value = state.eventName||'';
      document.getElementById('eventDate1').value = state.dates.day1||'';
      document.getElementById('eventDate2').value = state.dates.day2||'';
      document.getElementById('numGroups').value = state.numGroups||6;

      document.querySelectorAll('#dayTabs .tab').forEach(x=>{
        x.classList.toggle('active', x.dataset.day===state.currentDay);
      });
      document.querySelectorAll('#tabs .tab').forEach(x=>{
        x.classList.toggle('active', x.dataset.side===state.side);
      });

      // reflect current format.
      elFormat.value = state.format[state.currentDay][state.side] || 'Best Ball';
    }

    function renderAll(){
      hydrateControls();
      renderTeamFilters();
      renderPlayers();
      renderGrid();
      renderAssignmentsTable();
    }

    // Boot
    load();
    ensurePlayers();
    initGroupsIfNeeded();
    renderAll();
  </script>
</body>
</html>
